{% extends "store_base.html" %}

{% block title %}Shop Collection | Shop.co{% endblock %}

{% block content %}

<div class="shop-header-bg">
    <div class="container">
        <h1 class="shop-main-title">The Collection</h1>
        <p class="shop-sub-title">Explore our curated selection of premium essentials.</p>
    </div>
</div>

<div class="container shop-layout-grid">
    
    <aside class="shop-sidebar">
        <div class="sidebar-content-sticky">
            <div class="filter-header">
                <h2>Filters</h2>
                <a href="{{ url_for('store_shop') }}" class="clear-all-btn">Clear All</a>
            </div>

            <form action="{{ url_for('store_shop') }}" method="GET" id="filterForm">
                <input type="hidden" name="q" value="{{ search_query }}">
                <input type="hidden" name="sort" value="{{ current_sort }}">

                {% if current_cats or current_min_price or current_max_price %}
                <div class="filter-section applied-filters">
                    <h3>Applied Filters</h3>
                    <div class="chip-list">
                        {% for cat in current_cats %}
                        <span class="filter-chip">{{ cat }} <i class="fa-solid fa-xmark" onclick="removeCat('{{ cat }}')"></i></span>
                        {% endfor %}
                        {% if current_min_price %}
                        <span class="filter-chip">Min: ${{ current_min_price }} <i class="fa-solid fa-xmark" onclick="removePrice('min')"></i></span>
                        {% endif %}
                        {% if current_max_price %}
                        <span class="filter-chip">Max: ${{ current_max_price }} <i class="fa-solid fa-xmark" onclick="removePrice('max')"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div class="filter-section collapsible active">
                    <h3 onclick="toggleSection(this)">Category <i class="fa-solid fa-chevron-down"></i></h3>
                    <div class="section-content">
                        {% for cat in all_categories %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="category" value="{{ cat }}" 
                                   {% if cat in current_cats %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <span class="checkmark"></span>
                            {{ cat }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-section collapsible active">
                    <h3 onclick="toggleSection(this)">Price Range <i class="fa-solid fa-chevron-down"></i></h3>
                    <div class="section-content">
                        <div class="price-inputs">
                            <div class="price-field">
                                <span>$</span>
                                <input type="number" name="min_price" placeholder="{{ db_min_price }}" value="{{ current_min_price }}" min="0">
                            </div>
                            <span class="separator">-</span>
                            <div class="price-field">
                                <span>$</span>
                                <input type="number" name="max_price" placeholder="{{ db_max_price }}" value="{{ current_max_price }}" min="0">
                            </div>
                        </div>
                        <button type="submit" class="apply-price-btn">Apply</button>
                    </div>
                </div>
            </form>
        </div>
    </aside>

    <main class="shop-main-content">
        <div class="shop-toolbar">
            <span class="result-count">Showing {{ pagination.total }} results</span>
            <div class="sort-wrapper">
                <label for="sortSelect">Sort by:</label>
                <select id="sortSelect" onchange="updateSort(this.value)" class="sort-select">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest Arrivals</option>
                    <option value="popularity" {% if current_sort == 'popularity' %}selected{% endif %}>Best Selling</option>
                    <option value="price_low" {% if current_sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_high" {% if current_sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                </select>
            </div>
        </div>

        {% if products %}
            <div class="product-grid-3-col">
                {% for product in products %}
                <div class="product-card">
                    <div class="card-image-wrap">
                        <a href="{{ url_for('store_product', product_id=product.id) }}">
                            <img src="{{ product.image_url }}" alt="{{ product.name }}">
                        </a>
                        <form action="{{ url_for('store_cart') }}" method="POST">
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <input type="hidden" name="quantity" value="1">
                            <button type="submit" class="quick-add-icon" title="Add to Cart">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </form>
                        {% if product.sales_count > 300 %}
                            <span class="badge-hot">Hot</span>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('store_product', product_id=product.id) }}" class="card-info">
                        <div class="card-cat">{{ product.category }}</div>
                        <h3 class="card-name">{{ product.name }}</h3>
                        <div class="card-meta">
                            <span class="card-rating">
                                <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                            </span>
                            <span class="card-sold">{{ product.sales_count }} sold</span>
                        </div>
                        <div class="card-price">${{ "%.2f"|format(product.price) }}</div>
                    </a>
                </div>
                {% endfor %}
            </div>

            <div class="pagination-container">
                {% if pagination.has_prev %}
                <a href="{{ url_for('store_shop', page=pagination.prev_num, **request.args) }}" class="page-btn prev">
                    <i class="fa-solid fa-chevron-left"></i>
                </a>
                {% endif %}
                
                <div class="page-numbers">
                    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                        {% if page_num %}
                            {% if pagination.page == page_num %}
                                <span class="page-num active">{{ page_num }}</span>
                            {% else %}
                                <a href="{{ url_for('store_shop', page=page_num, **request.args) }}" class="page-num">{{ page_num }}</a>
                            {% endif %}
                        {% else %}
                            <span class="page-ellipsis">...</span>
                        {% endif %}
                    {% endfor %}
                </div>

                {% if pagination.has_next %}
                <a href="{{ url_for('store_shop', page=pagination.next_num, **request.args) }}" class="page-btn next">
                    <i class="fa-solid fa-chevron-right"></i>
                </a>
                {% endif %}
            </div>

        {% else %}
            <div class="no-results">
                <h3>No products found.</h3>
                <p>Try adjusting your filters.</p>
                <a href="{{ url_for('store_shop') }}" class="btn-reset">Clear All Filters</a>
            </div>
        {% endif %}
    </main>
</div>

<script>
    // Toggle collapsible filter sections
    function toggleSection(header) {
        header.parentElement.classList.toggle('active');
    }

    // Update sort order by submitting the form
    function updateSort(value) {
        const form = document.getElementById('filterForm');
        const sortInput = form.querySelector('input[name="sort"]');
        sortInput.value = value;
        form.submit();
    }

    // Remove a category chip
    function removeCat(catToRemove) {
        const form = document.getElementById('filterForm');
        const checkboxes = form.querySelectorAll('input[name="category"]');
        checkboxes.forEach(cb => {
            if (cb.value === catToRemove) {
                cb.checked = false;
            }
        });
        form.submit();
    }

    // Remove a price chip
    function removePrice(type) {
        const form = document.getElementById('filterForm');
        const input = form.querySelector(`input[name="${type}_price"]`);
        input.value = '';
        form.submit();
    }
</script>

<style>
    /* --- SHOP PAGE STYLES --- */
    :root { --border-color: #e5e5e5; --text-light: #777; }
    
    .shop-header-bg { background: #f9f9f9; padding: 60px 0; margin-bottom: 40px; text-align: center; border-bottom: 1px solid var(--border-color); }
    .shop-main-title { font-size: 36px; font-weight: 800; text-transform: uppercase; letter-spacing: -1px; margin: 0 0 10px; }
    .shop-sub-title { color: var(--text-light); font-size: 14px; margin: 0; }

    /* Layout Grid */
    .shop-layout-grid { display: grid; grid-template-columns: 240px 1fr; gap: 40px; align-items: start; padding-bottom: 60px; }
    
    /* --- SIDEBAR --- */
    .shop-sidebar { position: relative; }
    .sidebar-content-sticky { position: sticky; top: 100px; max-height: 80vh; overflow-y: auto; padding-right: 10px; }
    /* Custom scrollbar for sidebar */
    .sidebar-content-sticky::-webkit-scrollbar { width: 4px; }
    .sidebar-content-sticky::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

    .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .filter-header h2 { font-size: 18px; font-weight: 700; margin: 0; text-transform: uppercase; }
    .clear-all-btn { font-size: 12px; color: var(--text-light); text-decoration: underline; cursor: pointer; }
    .clear-all-btn:hover { color: black; }

    .filter-section { margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
    .filter-section:last-child { border-bottom: none; }
    .filter-section h3 { font-size: 14px; font-weight: 700; text-transform: uppercase; margin: 0 0 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .filter-section h3 i { font-size: 10px; transition: transform 0.3s; }
    
    /* Collapsible Logic */
    .filter-section.collapsible .section-content { display: none; }
    .filter-section.collapsible.active .section-content { display: block; }
    .filter-section.collapsible.active h3 i { transform: rotate(180deg); }

    /* Checkboxes */
    .checkbox-label { display: flex; align-items: center; position: relative; padding-left: 28px; margin-bottom: 12px; cursor: pointer; font-size: 14px; color: #333; user-select: none; }
    .checkbox-label input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
    .checkmark { position: absolute; top: 0; left: 0; height: 18px; width: 18px; background-color: #fff; border: 1px solid #ccc; border-radius: 3px; transition: 0.2s; }
    .checkbox-label:hover input ~ .checkmark { border-color: #999; }
    .checkbox-label input:checked ~ .checkmark { background-color: black; border-color: black; }
    .checkmark:after { content: ""; position: absolute; display: none; }
    .checkbox-label input:checked ~ .checkmark:after { display: block; left: 6px; top: 2px; width: 5px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }

    /* Price Inputs */
    .price-inputs { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .price-field { flex: 1; display: flex; align-items: center; border: 1px solid #ddd; padding: 0 10px; border-radius: 4px; background: #fff; }
    .price-field span { color: #999; font-size: 13px; }
    .price-field input { width: 100%; border: none; outline: none; padding: 8px 5px; font-size: 13px; }
    .apply-price-btn { width: 100%; background: black; color: white; border: none; padding: 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 4px; }
    .apply-price-btn:hover { opacity: 0.9; }

    /* Applied Filter Chips */
    .chip-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .filter-chip { background: #f0f0f0; color: #333; font-size: 12px; padding: 6px 10px; border-radius: 20px; display: flex; align-items: center; gap: 6px; }
    .filter-chip i { cursor: pointer; font-size: 10px; color: #999; transition: 0.2s; }
    .filter-chip i:hover { color: black; }

    /* --- MAIN CONTENT --- */
    .shop-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); font-size: 13px; color: var(--text-light); }
    .sort-wrapper { display: flex; align-items: center; gap: 10px; }
    .sort-select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; cursor: pointer; font-family: inherit; font-size: 13px; }

    /* Product Grid (3 Columns) */
    .product-grid-3-col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 50px; }

    /* --- COPIED CARD STYLES (from Home) --- */
    .product-card { background: transparent; transition: transform 0.3s ease; border-radius: 4px; }
    .product-card:hover { transform: translateY(-5px); }
    .card-image-wrap { position: relative; aspect-ratio: 4/5; background: #f0f0f0; overflow: hidden; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: 0.3s; }
    .product-card:hover .card-image-wrap { box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
    .card-image-wrap img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.7s ease; }
    .product-card:hover img { transform: scale(1.08); }
    .card-info { padding: 12px 0; display: block; text-align: center; color: inherit; }
    .card-cat { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #999; margin-bottom: 4px; letter-spacing: 1px; }
    .card-name { font-size: 14px; font-weight: 600; margin: 0 0 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #111; }
    .card-rating { font-size: 10px; color: #FFD700; margin-bottom: 0; }
    .card-sold { font-weight: 700; color: #777; margin-left: 5px; }
    .card-meta { display: flex; justify-content: center; align-items: center; gap: 5px; font-size: 10px; margin-bottom: 5px; }
    .card-price { font-size: 14px; font-weight: 800; color: #111; }
    .quick-add-icon { position: absolute; bottom: 15px; right: 15px; width: 32px; height: 32px; border-radius: 50%; background: white; color: black; border: none; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; opacity: 0; transform: translateY(10px) scale(0.9); transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .quick-add-icon:hover { background: black; color: white; }
    .product-card:hover .quick-add-icon { opacity: 1; transform: translateY(0) scale(1); }
    .badge-hot { position: absolute; top: 10px; left: 10px; background: #e11d48; color: white; padding: 4px 8px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

    /* --- PAGINATION --- */
    .pagination-container { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 40px; }
    .page-btn { width: 40px; height: 40px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: #333; transition: 0.2s; }
    .page-btn:hover { background: #f0f0f0; border-color: #ccc; }
    .page-numbers { display: flex; gap: 5px; }
    .page-num { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 14px; color: #555; transition: 0.2s; }
    .page-num:hover { background: #f9f9f9; color: black; }
    .page-num.active { background: black; color: white; font-weight: 700; }
    .page-ellipsis { display: flex; align-items: flex-end; padding: 0 5px; color: #999; }

    /* No Results */
    .no-results { text-align: center; padding: 100px 0; color: #555; }
    .btn-reset { display: inline-block; background: black; color: white; padding: 10px 20px; font-size: 13px; font-weight: 700; border-radius: 4px; margin-top: 20px; }

    /* Responsive */
    @media (max-width: 992px) {
        .shop-layout-grid { grid-template-columns: 1fr; gap: 30px; }
        .shop-sidebar { margin-bottom: 40px; }
        .sidebar-content-sticky { position: static; max-height: none; }
        .product-grid-3-col { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
        .shop-toolbar { flex-direction: column; align-items: flex-start; gap: 10px; }
        .sort-wrapper { width: 100%; justify-content: space-between; }
    }
</style>

{% endblock %}