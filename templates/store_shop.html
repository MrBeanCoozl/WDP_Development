{% extends "store_base.html" %}

{% block title %}Shop Collection{% endblock %}

{% block content %}

<div class="container shop-container">
    
    <aside class="sidebar-wrapper">
        <div class="sidebar-sticky-content">
            
            <div class="filter-group">
                <h3 class="filter-title">Categories</h3>
                <ul class="cat-list">
                    <li><a href="{{ url_for('store_shop', category='All') }}" class="cat-link {% if current_cat == 'All' %}active{% endif %}">All Products</a></li>
                    {% for cat in all_categories %}
                    <li><a href="{{ url_for('store_shop', category=cat) }}" class="cat-link {% if current_cat == cat %}active{% endif %}">{{ cat }}</a></li>
                    {% endfor %}
                </ul>
            </div>

            <form action="{{ url_for('store_shop') }}" method="GET" id="filterForm">
                <input type="hidden" name="category" value="{{ current_cat }}">
                <input type="hidden" name="sort" value="{{ current_sort }}">
                <input type="hidden" name="q" value="{{ search_query }}">

                <div class="filter-group">
                    <h3 class="filter-title">Price Range</h3>
                    <div class="range-slider">
                        <input type="range" min="{{ db_min_price }}" max="{{ db_max_price }}" value="{{ current_min_price if current_min_price else db_min_price }}" id="slider-1" oninput="slideOne()">
                        <input type="range" min="{{ db_min_price }}" max="{{ db_max_price }}" value="{{ current_max_price if current_max_price else db_max_price }}" id="slider-2" oninput="slideTwo()">
                    </div>
                    <div class="price-inputs">
                        <div class="price-field"><span>$</span><input type="number" name="min_price" id="range1" value="{{ current_min_price if current_min_price else db_min_price }}"></div>
                        <span class="separator">-</span>
                        <div class="price-field"><span>$</span><input type="number" name="max_price" id="range2" value="{{ current_max_price if current_max_price else db_max_price }}"></div>
                    </div>
                    <button type="submit" class="btn-apply">Apply</button>
                </div>

                <div class="filter-group">
                    <h3 class="filter-title">Size</h3>
                    <div class="size-grid">
                        {% set sizes = ['XS', 'S', 'M', 'L', 'XL', '7', '8', '9', '10', '11'] %}
                        {% for size in sizes %}
                        <label class="size-box">
                            <input type="checkbox" name="size" value="{{ size }}" {% if size in selected_sizes %}checked{% endif %} onchange="this.form.submit()">
                            <span class="size-text">{{ size }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-footer">
                    <a href="{{ url_for('store_shop', category=current_cat) }}" class="btn-reset">Reset Filters</a>
                </div>
            </form>
        </div>
    </aside>

    <main class="main-content">
        <div class="shop-header animate-fade-down">
            <div>
                <h1 class="page-title">{{ current_cat }}</h1>
                <p class="results-text">Showing {{ pagination.total }} items</p>
            </div>
            <div class="sort-wrapper">
                <select onchange="updateSort(this.value)" class="sort-select">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest Arrivals</option>
                    <option value="popularity" {% if current_sort == 'popularity' %}selected{% endif %}>Most Popular</option>
                    <option value="price_low" {% if current_sort == 'price_low' %}selected{% endif %}>Price: Low - High</option>
                    <option value="price_high" {% if current_sort == 'price_high' %}selected{% endif %}>Price: High - Low</option>
                </select>
            </div>
        </div>

        {% if products %}
            <div class="product-grid">
                {% for product in products %}
                <div class="product-card animate-fade-up" style="animation-delay: {{ loop.index0 * 0.05 }}s;">
                    <div class="card-image-wrap">
                        <a href="{{ url_for('store_product', product_id=product.id) }}">
                            <img src="{{ product.image_url }}" alt="{{ product.name }}">
                        </a>
                        <form action="{{ url_for('store_cart') }}" method="POST">
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <input type="hidden" name="quantity" value="1">
                            <button type="submit" class="quick-add-btn"><i class="fa-solid fa-plus"></i></button>
                        </form>
                        {% if product.sales_count > 150 %}<span class="badge-hot">Hot</span>{% endif %}
                    </div>
                    <div class="card-details">
                        <div class="card-cat">{{ product.category }}</div>
                        <h3 class="card-name">{{ product.name }}</h3>
                        <div class="card-price">${{ "%.2f"|format(product.price) }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="pagination animate-fade-up" style="animation-delay: 0.5s;">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('store_shop', page=pagination.prev_num, category=current_cat, sort=current_sort, q=search_query, min_price=current_min_price, max_price=current_max_price, size=selected_sizes) }}" class="page-btn"><i class="fa-solid fa-chevron-left"></i></a>
                {% endif %}
                <span class="page-info">Page {{ pagination.page }} of {{ pagination.pages }}</span>
                {% if pagination.has_next %}
                    <a href="{{ url_for('store_shop', page=pagination.next_num, category=current_cat, sort=current_sort, q=search_query, min_price=current_min_price, max_price=current_max_price, size=selected_sizes) }}" class="page-btn"><i class="fa-solid fa-chevron-right"></i></a>
                {% endif %}
            </div>
        {% else %}
            <div class="no-results animate-fade-up">
                <h3>No items found</h3>
                <a href="{{ url_for('store_shop', category='All') }}" class="btn-home">Clear Filters</a>
            </div>
        {% endif %}
    </main>
</div>

<script>
    function updateSort(val) { document.getElementById('filterForm').querySelector('input[name="sort"]').value = val; document.getElementById('filterForm').submit(); }
    let sliderOne = document.getElementById("slider-1"); let sliderTwo = document.getElementById("slider-2");
    let displayValOne = document.getElementById("range1"); let displayValTwo = document.getElementById("range2");
    let minGap = 10;
    function slideOne() { if (parseInt(sliderTwo.value) - parseInt(sliderOne.value) <= minGap) { sliderOne.value = parseInt(sliderTwo.value) - minGap; } displayValOne.value = sliderOne.value; }
    function slideTwo() { if (parseInt(sliderTwo.value) - parseInt(sliderOne.value) <= minGap) { sliderTwo.value = parseInt(sliderOne.value) + minGap; } displayValTwo.value = sliderTwo.value; }
</script>

<style>
    /* Layout */
    .shop-container { display: grid; grid-template-columns: 260px 1fr; gap: 60px; padding-top: 30px; padding-bottom: 60px; align-items: start; }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 40px; }

    /* Animations */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-up { animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) backwards; }
    .animate-fade-down { animation: fadeDown 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) backwards; }

    /* Sticky Sidebar with Hidden Scrollbar */
    .sidebar-wrapper {
        position: sticky; top: 100px; 
        height: calc(100vh - 100px); 
        overflow-y: auto; padding-right: 10px;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none;  /* IE */
    }
    .sidebar-wrapper::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

    /* Filter Styles */
    .filter-group { margin-bottom: 40px; }
    .filter-title { font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 20px; color: #111; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    
    .cat-list { list-style: none; padding: 0; }
    .cat-link { font-size: 14px; color: #666; display: block; padding: 6px 0; transition: 0.2s; }
    .cat-link:hover, .cat-link.active { color: black; font-weight: 600; }

    /* Price Slider */
    .range-slider { position: relative; height: 4px; background: #e5e5e5; border-radius: 5px; margin: 25px 0 20px; }
    .range-slider input[type="range"] { position: absolute; top: -6px; width: 100%; background: none; pointer-events: none; -webkit-appearance: none; }
    .range-slider input[type="range"]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: black; pointer-events: auto; -webkit-appearance: none; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .price-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
    .price-field { display: flex; align-items: center; border: 1px solid #e5e5e5; padding: 8px 12px; border-radius: 6px; font-size: 13px; flex: 1; background: #fff; }
    .price-field input { width: 100%; border: none; outline: none; margin-left: 5px; font-weight: 500; }
    .btn-apply { width: 100%; background: black; color: white; border: none; padding: 10px; font-size: 12px; font-weight: 700; text-transform: uppercase; border-radius: 6px; cursor: pointer; }

    /* Size Grid */
    .size-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .size-box input { display: none; }
    .size-text { display: flex; align-items: center; justify-content: center; height: 40px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; transition: 0.2s; background: #fff; }
    .size-box:hover .size-text { border-color: #999; color: black; }
    .size-box input:checked + .size-text { background: black; color: white; border-color: black; }

    .btn-reset { display: block; width: 100%; text-align: center; font-size: 13px; text-decoration: none; color: #555; border: 1px solid #e5e5e5; padding: 10px; border-radius: 6px; margin-top: 30px; background: #f9f9f9; }
    .btn-reset:hover { background: #eee; color: black; }

    /* Main Content */
    .shop-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; border-bottom: 1px solid #f0f0f0; padding-bottom: 20px; }
    .page-title { font-size: 36px; font-weight: 800; text-transform: uppercase; margin: 0; line-height: 1; }
    .results-text { color: #777; font-size: 13px; margin: 5px 0 0; }
    .sort-select { padding: 10px 15px; border: 1px solid #e5e5e5; font-size: 13px; border-radius: 6px; outline: none; cursor: pointer; background: white; }

    .product-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-bottom: 60px; }
    .product-card { background: transparent; transition: transform 0.3s ease; }
    .product-card:hover { transform: translateY(-5px); }
    .card-image-wrap { position: relative; aspect-ratio: 4/5; background: #f0f0f0; overflow: hidden; border-radius: 6px; margin-bottom: 15px; }
    .card-image-wrap img { width: 100%; height: 100%; object-fit: cover; transition: 0.7s; }
    .product-card:hover img { transform: scale(1.08); }
    .quick-add-btn { position: absolute; bottom: 15px; right: 15px; width: 35px; height: 35px; border-radius: 50%; background: white; border: none; display: flex; align-items: center; justify-content: center; opacity: 0; transform: translateY(10px); transition: 0.3s; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .product-card:hover .quick-add-btn { opacity: 1; transform: translateY(0); }
    .card-name { font-size: 15px; font-weight: 600; margin: 0 0 6px; }
    .card-cat { font-size: 11px; font-weight: 700; color: #999; margin-bottom: 6px; text-transform: uppercase; }
    
    .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; }
    .page-btn { width: 40px; height: 40px; border: 1px solid #e5e5e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .page-btn:hover { background: #111; border-color: #111; color: white; }

    @media (max-width: 992px) {
        .shop-container { grid-template-columns: 1fr; }
        .sidebar-wrapper { position: static; height: auto; margin-bottom: 40px; padding-right: 0; }
        .product-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
        .product-grid { grid-template-columns: 1fr; }
    }
</style>

{% endblock %}