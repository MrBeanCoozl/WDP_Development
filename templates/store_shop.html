{% extends "store_base.html" %}

{% block title %}Shop Collection{% endblock %}

{% block content %}

<style>
    .flying-img {
        position: fixed;
        z-index: 9999;
        border-radius: 50%;
        opacity: 0.9;
        pointer-events: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
    }
</style>

<div class="container shop-container">
    
    <aside class="sidebar-wrapper">
        <div class="sidebar-sticky-content">
            
            <div class="filter-group">
                <h3 class="filter-title">Categories</h3>
                <ul class="cat-list">
                    <li><a href="{{ url_for('store_shop', category='All') }}" class="cat-link {% if current_cat == 'All' %}active{% endif %}">All Products</a></li>
                    {% for cat in all_categories %}
                    <li><a href="{{ url_for('store_shop', category=cat) }}" class="cat-link {% if current_cat == cat %}active{% endif %}">{{ cat }}</a></li>
                    {% endfor %}
                </ul>
            </div>

            <form action="{{ url_for('store_shop') }}" method="GET" id="filterForm">
                <input type="hidden" name="category" value="{{ current_cat }}">
                <input type="hidden" name="sort" value="{{ current_sort }}">
                <input type="hidden" name="q" value="{{ search_query }}">

                <div class="filter-group">
                    <h3 class="filter-title">Price Range</h3>
                    <div class="range-slider">
                        <input type="range" min="{{ db_min_price }}" max="{{ db_max_price }}" value="{{ current_min_price if current_min_price else db_min_price }}" id="slider-1" oninput="slideOne()">
                        <input type="range" min="{{ db_min_price }}" max="{{ db_max_price }}" value="{{ current_max_price if current_max_price else db_max_price }}" id="slider-2" oninput="slideTwo()">
                    </div>
                    <div class="price-inputs">
                        <div class="price-field"><span>$</span><input type="number" name="min_price" id="range1" value="{{ current_min_price if current_min_price else db_min_price }}"></div>
                        <span class="separator">-</span>
                        <div class="price-field"><span>$</span><input type="number" name="max_price" id="range2" value="{{ current_max_price if current_max_price else db_max_price }}"></div>
                    </div>
                    <button type="submit" class="btn-apply">Apply</button>
                </div>

                <div class="filter-group">
                    <h3 class="filter-title">Size</h3>
                    <div class="size-grid">
                        {% set sizes = ['XS', 'S', 'M', 'L', 'XL', '7', '8', '9', '10', '11'] %}
                        {% for size in sizes %}
                        <label class="size-box">
                            <input type="checkbox" name="size" value="{{ size }}" {% if size in selected_sizes %}checked{% endif %} onchange="this.form.submit()">
                            <span class="size-text">{{ size }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-footer">
                    <a href="{{ url_for('store_shop', category=current_cat) }}" class="btn-reset">Reset Filters</a>
                </div>
            </form>
        </div>
    </aside>

    <main class="main-content">
        <div class="shop-header animate-fade-down">
            <div>
                <h1 class="page-title">{{ current_cat }}</h1>
                <p class="results-text">Showing {{ pagination.total }} items</p>
            </div>
            <div class="sort-wrapper">
                <select onchange="updateSort(this.value)" class="sort-select">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest Arrivals</option>
                    <option value="popularity" {% if current_sort == 'popularity' %}selected{% endif %}>Most Popular</option>
                    <option value="price_low" {% if current_sort == 'price_low' %}selected{% endif %}>Price: Low - High</option>
                    <option value="price_high" {% if current_sort == 'price_high' %}selected{% endif %}>Price: High - Low</option>
                </select>
            </div>
        </div>

{% if products %}
            <div class="product-grid">
                {% for product in products %}
                <div class="product-card animate-fade-up" style="animation-delay: {{ loop.index0 * 0.05 }}s;">
                    <div class="card-image-wrap">
                        <a href="{{ url_for('store_product', product_id=product.id) }}">
                            {% set first_raw = product.image_url.split('|')[0].strip() if product.image_url else 'default.jpg' %}
                            {% set img_src = first_raw if first_raw.startswith('http') else url_for('static', filename='product_images/' + first_raw) %}
                            <img src="{{ img_src }}" alt="{{ product.name }}" id="img-shop-{{ product.id }}">
                        </a>
                        <form action="{{ url_for('store_cart') }}" method="POST" class="ajax-cart-form" data-id="{{ product.id }}" data-prefix="shop-">
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <input type="hidden" name="quantity" value="1">
                            <button type="submit" class="quick-add-btn"><i class="fa-solid fa-plus"></i></button>
                        </form>
                        {% if product.sales_count > 150 %}<span class="badge-hot">Hot</span>{% endif %}
                    </div>
                    <div class="card-details">
                        <div class="card-cat">{{ product.category }}</div>
                        <h3 class="card-name">{{ product.name }}</h3>
                        <div class="card-price">${{ "%.2f"|format(product.price) }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="pagination animate-fade-up" style="animation-delay: 0.5s;">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('store_shop', page=pagination.prev_num, category=current_cat, sort=current_sort, q=search_query, min_price=current_min_price, max_price=current_max_price, size=selected_sizes) }}" class="page-btn"><i class="fa-solid fa-chevron-left"></i></a>
                {% endif %}
                <span class="page-info">Page {{ pagination.page }} of {{ pagination.pages }}</span>
                {% if pagination.has_next %}
                    <a href="{{ url_for('store_shop', page=pagination.next_num, category=current_cat, sort=current_sort, q=search_query, min_price=current_min_price, max_price=current_max_price, size=selected_sizes) }}" class="page-btn"><i class="fa-solid fa-chevron-right"></i></a>
                {% endif %}
            </div>
        {% else %}
            <div class="no-results animate-fade-up">
                <h3>No items found</h3>
                <a href="{{ url_for('store_shop', category='All') }}" class="btn-home">Clear Filters</a>
            </div>
        {% endif %}
    </main>
</div>

<script>
    function updateSort(val) { document.getElementById('filterForm').querySelector('input[name="sort"]').value = val; document.getElementById('filterForm').submit(); }
    let sliderOne = document.getElementById("slider-1"); let sliderTwo = document.getElementById("slider-2");
    let displayValOne = document.getElementById("range1"); let displayValTwo = document.getElementById("range2");
    let minGap = 10;
    function slideOne() { if (parseInt(sliderTwo.value) - parseInt(sliderOne.value) <= minGap) { sliderOne.value = parseInt(sliderTwo.value) - minGap; } displayValOne.value = sliderOne.value; }
    function slideTwo() { if (parseInt(sliderTwo.value) - parseInt(sliderOne.value) <= minGap) { sliderTwo.value = parseInt(sliderOne.value) + minGap; } displayValTwo.value = sliderTwo.value; }

    // AJAX CART LOGIC
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('.ajax-cart-form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); 
                
                const btn = this.querySelector('button');
                const productId = this.dataset.id;
                const prefix = this.dataset.prefix || '';
                const sourceImg = document.getElementById(`img-${prefix}${productId}`);
                const cartIcon = document.querySelector('.fa-bag-shopping');
                
                // Animation
                if (sourceImg && cartIcon) {
                    const flyingImg = sourceImg.cloneNode();
                    flyingImg.classList.add('flying-img');
                    
                    const startRect = sourceImg.getBoundingClientRect();
                    const endRect = cartIcon.getBoundingClientRect();
                    
                    flyingImg.style.width = startRect.width + 'px';
                    flyingImg.style.height = startRect.height + 'px';
                    flyingImg.style.top = startRect.top + 'px';
                    flyingImg.style.left = startRect.left + 'px';
                    
                    document.body.appendChild(flyingImg);
                    
                    void flyingImg.offsetWidth; 
                    
                    flyingImg.style.top = (endRect.top + 5) + 'px';
                    flyingImg.style.left = (endRect.left + 5) + 'px';
                    flyingImg.style.width = '20px';
                    flyingImg.style.height = '20px';
                    flyingImg.style.opacity = '0';
                    
                    setTimeout(() => {
                        flyingImg.remove();
                        cartIcon.parentElement.style.transform = 'scale(1.2)';
                        cartIcon.parentElement.style.transition = 'transform 0.2s';
                        setTimeout(() => cartIcon.parentElement.style.transform = 'scale(1)', 200);
                    }, 800);
                }
                
                // Fetch
                const formData = new FormData(this);
                fetch("{{ url_for('store_cart') }}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        let badge = document.querySelector('.nav-icon .badge');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'badge';
                            document.querySelector('.fa-bag-shopping').parentElement.appendChild(badge);
                        }
                        badge.textContent = data.cart_count;
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>

<style>
    /* PRESERVED LAYOUT STYLES - UNCHANGED */
    .shop-container { display: grid; grid-template-columns: 260px 1fr; gap: 60px; padding-top: 30px; padding-bottom: 60px; align-items: start; }
    .sidebar-sticky-content { position: sticky; top: 100px; padding-right: 20px; }
    
    .filter-group { margin-bottom: 35px; border-bottom: 1px solid #eee; padding-bottom: 25px; }
    .filter-group:last-child { border-bottom: none; }
    .filter-title { font-size: 14px; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; }
    
    .cat-list li { margin-bottom: 10px; }
    .cat-link { color: #555; font-size: 14px; transition: 0.2s; position: relative; padding-left: 0; }
    .cat-link:hover, .cat-link.active { color: black; font-weight: 600; padding-left: 5px; }
    .cat-link.active::before { content: 'â€¢'; position: absolute; left: -10px; color: black; }
    
    /* Range Slider */
    .range-slider { position: relative; width: 100%; height: 5px; background: #ddd; border-radius: 5px; margin: 20px 0; }
    .range-slider input { position: absolute; top: -5px; width: 100%; background: none; pointer-events: none; -webkit-appearance: none; }
    .range-slider input::-webkit-slider-thumb { height: 15px; width: 15px; border-radius: 50%; background: black; pointer-events: auto; -webkit-appearance: none; cursor: pointer; }
    
    .price-inputs { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
    .price-field { display: flex; align-items: center; border: 1px solid #eee; padding: 5px 10px; border-radius: 4px; width: 45%; }
    .price-field span { font-size: 12px; color: #999; margin-right: 5px; }
    .price-field input { width: 100%; border: none; outline: none; font-size: 13px; font-weight: 600; }
    .separator { color: #999; font-size: 12px; }
    .btn-apply { width: 100%; background: black; color: white; border: none; padding: 10px; margin-top: 15px; font-size: 12px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 4px; }
    
    .size-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .size-box { position: relative; cursor: pointer; }
    .size-box input { display: none; }
    .size-text { display: flex; align-items: center; justify-content: center; height: 35px; border: 1px solid #eee; font-size: 12px; font-weight: 600; color: #555; transition: 0.2s; border-radius: 4px; }
    .size-box input:checked + .size-text { background: black; color: white; border-color: black; }
    .size-text:hover { border-color: black; }
    
    .btn-reset { display: block; text-align: center; font-size: 12px; text-decoration: underline; color: #666; margin-top: 20px; }
    
    /* Main Content */
    .shop-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .page-title { font-size: 24px; font-weight: 800; text-transform: uppercase; margin: 0 0 5px; }
    .results-text { font-size: 13px; color: #666; margin: 0; }
    .sort-select { padding: 8px 12px; border: 1px solid #eee; border-radius: 4px; font-size: 13px; outline: none; cursor: pointer; }
    
    .product-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; }
    .product-card { position: relative; }
    .card-image-wrap { position: relative; background: #f4f4f5; aspect-ratio: 4/5; overflow: hidden; margin-bottom: 15px; border-radius: 4px; }
    .card-image-wrap img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .product-card:hover img { transform: scale(1.08); }
    
    .quick-add-btn { position: absolute; bottom: 15px; right: 15px; width: 35px; height: 35px; border-radius: 50%; background: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; opacity: 0; transform: translateY(10px); transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .quick-add-btn:hover { background: black; color: white; }
    .product-card:hover .quick-add-btn { opacity: 1; transform: translateY(0); }
    
    .badge-hot { position: absolute; top: 10px; left: 10px; background: #e11d48; color: white; font-size: 9px; font-weight: 800; padding: 4px 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .card-details { text-align: left; }
    .card-cat { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #999; margin-bottom: 5px; }
    .card-name { font-size: 14px; font-weight: 600; margin: 0 0 5px; color: #111; }
    .card-price { font-size: 14px; font-weight: 700; color: #111; }
    
    .pagination { margin-top: 50px; display: flex; justify-content: center; align-items: center; gap: 15px; }
    .page-btn { width: 35px; height: 35px; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 12px; border-radius: 4px; transition: 0.2s; }
    .page-btn:hover { border-color: black; background: black; color: white; }
    .page-info { font-size: 13px; font-weight: 600; }
    
    .no-results { text-align: center; padding: 60px 0; background: #f9f9f9; border-radius: 8px; }
    .btn-home { display: inline-block; margin-top: 15px; color: black; text-decoration: underline; font-weight: 600; font-size: 13px; }

    @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-down { animation: fadeDown 0.8s ease backwards; }
    .animate-fade-up { animation: fadeUp 0.8s ease backwards; }

    @media (max-width: 1024px) { .product-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 900px) { .shop-container { grid-template-columns: 1fr; gap: 30px; } .sidebar-wrapper { display: none; } } /* Hide Sidebar on Mobile for simplicity or change to drawer */
</style>
{% endblock %}