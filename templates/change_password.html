{% extends "base.html" %}

{% block header %}
    Security Setup
{% endblock %}

{% block content %}
<style>
    /* Input Group Styling for Eye Icon */
    .password-input-group {
        position: relative;
    }
    .password-input-group input {
        width: 100%;
        padding: 10px;
        padding-right: 40px; /* Space for the icon */
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
    }
    .toggle-password {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #95a5a6;
        z-index: 10;
        transition: color 0.2s;
    }
    .toggle-password:hover {
        color: #34495e;
    }

    /* Password Requirements UI */
    .requirements-box {
        background: #fdfdfd;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 15px;
        margin-top: 10px;
        margin-bottom: 20px;
        font-size: 13px;
    }
    .requirements-title {
        font-weight: bold;
        color: #555;
        margin-bottom: 8px;
        display: block;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .req-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr 1fr; /* Two columns layout */
        gap: 5px;
    }
    .req-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #7f8c8d;
        transition: all 0.2s;
    }
    .req-item i {
        font-size: 14px;
        width: 16px;
        text-align: center;
    }
    
    /* Dynamic States */
    .req-item.invalid { color: #e74c3c; } /* Red */
    .req-item.valid { color: #27ae60; font-weight: 500; } /* Green */
    
    .match-status {
        font-size: 13px;
        margin-top: 5px;
        font-weight: bold;
        display: none; /* Hidden by default */
    }
    .match-status.match { color: #27ae60; display: block; }
    .match-status.no-match { color: #e74c3c; display: block; }

</style>

<div class="card" style="max-width: 500px; margin: 40px auto; text-align: left;">
    <h2 style="margin-bottom: 20px; color: #e74c3c; border-bottom: 1px solid #eee; padding-bottom: 10px;">
        <i class="fa-solid fa-shield-halved"></i> Account Activation
    </h2>
    
    <p style="margin-bottom: 20px; line-height: 1.5; color: #555;">
        Please set up your personal password to proceed.
    </p>

    <form method="POST" id="passwordForm">
        {% if not user.email %}
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                    Recovery Email Address 
                    {% if not email_required %}
                        <span style="font-weight:normal; color:#888; font-size: 12px;">(Optional)</span>
                    {% endif %}
                </label>
                <input type="email" name="email" 
                       {% if email_required %}required{% endif %}
                       placeholder="e.g. yourname@company.com"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                
                {% if email_required %}
                <small style="color: #e67e22; display:block; margin-top:5px;">
                    <i class="fa-solid fa-circle-exclamation"></i> Required for future password resets.
                </small>
                {% else %}
                <small style="color: #7f8c8d; display:block; margin-top:5px;">
                    <i class="fa-solid fa-info-circle"></i> Recommended for password recovery.
                </small>
                {% endif %}
            </div>
        {% else %}
            <div style="margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
                <span style="display: block; font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Linked Recovery Email</span>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px; color: #2c3e50; font-weight: 500;">
                    <i class="fa-solid fa-envelope" style="color: #3498db;"></i>
                    {{ user.email }}
                    <span style="font-size: 12px; color: #27ae60; background: #e8f8f5; padding: 2px 6px; border-radius: 4px; margin-left: auto;">Verified</span>
                </div>
            </div>
        {% endif %}

        <div style="margin-bottom: 5px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">New Password</label>
            <div class="password-input-group">
                <input type="password" name="new_password" id="new_password" required placeholder="Enter new password">
                <i class="fa-solid fa-eye toggle-password" onclick="toggleVisibility('new_password', this)"></i>
            </div>
        </div>

        <div class="requirements-box">
            <span class="requirements-title">Security Requirements:</span>
            <ul class="req-list">
                <li id="req-length" class="req-item invalid"><i class="fa-solid fa-xmark"></i> 8+ Characters</li>
                <li id="req-upper" class="req-item invalid"><i class="fa-solid fa-xmark"></i> Uppercase Letter</li>
                <li id="req-lower" class="req-item invalid"><i class="fa-solid fa-xmark"></i> Lowercase Letter</li>
                <li id="req-number" class="req-item invalid"><i class="fa-solid fa-xmark"></i> Number (0-9)</li>
                <li id="req-special" class="req-item invalid"><i class="fa-solid fa-xmark"></i> Special Char (!@#$%)</li>
            </ul>
        </div>

        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Confirm Password</label>
            <div class="password-input-group">
                <input type="password" name="confirm_password" id="confirm_password" required placeholder="Re-enter password">
                <i class="fa-solid fa-eye toggle-password" onclick="toggleVisibility('confirm_password', this)"></i>
            </div>
            <div id="match-msg" class="match-status"></div>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px; opacity: 0.7; pointer-events: none;">
            Save Credentials & Login
        </button>
    </form>
</div>

<script>
    // 1. Toggle Password Visibility
    function toggleVisibility(fieldId, icon) {
        const input = document.getElementById(fieldId);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
        } else {
            input.type = "password";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
        }
    }

    // 2. Real-time Validation
    const passwordInput = document.getElementById('new_password');
    const confirmInput = document.getElementById('confirm_password');
    const submitBtn = document.getElementById('submitBtn');
    const matchMsg = document.getElementById('match-msg');

    // Regex patterns matching app.py logic exactly
    const patterns = {
        length: /.{8,}/,
        upper: /[A-Z]/,
        lower: /[a-z]/,
        number: /\d/,
        special: /[ !@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/
    };

    function validatePassword() {
        const val = passwordInput.value;
        let allValid = true;

        // Check each requirement
        for (const key in patterns) {
            const el = document.getElementById(`req-${key}`);
            const icon = el.querySelector('i');
            
            if (patterns[key].test(val)) {
                el.classList.remove('invalid');
                el.classList.add('valid');
                icon.className = 'fa-solid fa-check';
            } else {
                el.classList.remove('valid');
                el.classList.add('invalid');
                icon.className = 'fa-solid fa-xmark';
                allValid = false;
            }
        }

        // Check Match
        const confirmVal = confirmInput.value;
        let matchValid = false;
        
        if (confirmVal.length > 0) {
            if (val === confirmVal) {
                matchMsg.textContent = "Passwords match!";
                matchMsg.className = "match-status match";
                matchValid = true;
            } else {
                matchMsg.textContent = "Passwords do not match.";
                matchMsg.className = "match-status no-match";
            }
        } else {
            matchMsg.className = "match-status"; // Hide
        }

        // Enable/Disable Submit Button
        if (allValid && matchValid) {
            submitBtn.style.opacity = "1";
            submitBtn.style.pointerEvents = "auto";
        } else {
            submitBtn.style.opacity = "0.7";
            submitBtn.style.pointerEvents = "none";
        }
    }

    // Listeners
    passwordInput.addEventListener('input', validatePassword);
    confirmInput.addEventListener('input', validatePassword);
</script>
{% endblock %}