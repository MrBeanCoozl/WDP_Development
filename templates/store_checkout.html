{% extends "store_base.html" %}
{% block content %}
<style>
    body { background: #f9f9f9; }
    .checkout-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 40px; align-items: start; }
    
    .checkout-form-section { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #e5e5e5; }
    .section-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; color: #444; }
    .form-input { width: 100%; padding: 14px; border: 1px solid #e5e5e5; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: 0.2s; }
    .form-input:focus { border-color: black; outline: none; }
    
    /* Payment Tabs */
    .payment-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    .p-tab { flex: 1; border: 1px solid #e5e5e5; padding: 15px; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.2s; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
    .p-tab:hover { border-color: #999; }
    .p-tab.active { border-color: black; background: #f9f9f9; box-shadow: 0 0 0 1px black; }
    .p-tab i { font-size: 20px; }
    .p-tab span { font-size: 11px; font-weight: 700; }
    
    .payment-content { display: none; }
    .payment-content.active { display: block; }
    
    /* Saved Card Radio */
    .saved-card-option { border: 1px solid #e5e5e5; padding: 15px; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
    .saved-card-option:hover { background: #f9f9f9; }
    .saved-card-option input { accent-color: black; }
    
    .order-summary { background: #fff; padding: 30px; border-radius: 8px; border: 1px solid #e5e5e5; position: sticky; top: 100px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; color: #555; }
    .summary-total { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; font-weight: 800; font-size: 18px; color: black; }
    
    .btn-pay { width: 100%; background: black; color: white; padding: 18px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; text-transform: uppercase; cursor: pointer; margin-top: 20px; transition: 0.2s; }
    .btn-pay:hover { opacity: 0.9; }

    @media (max-width: 900px) { .checkout-container { grid-template-columns: 1fr; } .order-summary { position: static; margin-bottom: 40px; order: -1; } }
</style>

<div class="checkout-container">
    
    <div class="checkout-form-section">
        <form method="POST" id="checkoutForm">
            
            <div class="section-header">Shipping Details</div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" name="first_name" class="form-input" value="{{ user.first_name }}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" name="last_name" class="form-input" value="{{ user.last_name }}" required>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Address</label>
                <input type="text" name="address" class="form-input" placeholder="123 Main St" required>
            </div>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">City</label><input type="text" name="city" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Postal Code</label><input type="text" name="zip" class="form-input" required></div>
            </div>

            <div class="section-header" style="margin-top: 40px;">Payment Method</div>
            
            <input type="hidden" name="payment_type" id="paymentTypeInput" value="card">
            
            <div class="payment-tabs">
                <div class="p-tab active" onclick="selectPayment('card', this)">
                    <i class="fa-regular fa-credit-card"></i><span>Card</span>
                </div>
                <div class="p-tab" onclick="selectPayment('apple', this)">
                    <i class="fa-brands fa-apple"></i><span>Apple Pay</span>
                </div>
                <div class="p-tab" onclick="selectPayment('google', this)">
                    <i class="fa-brands fa-google"></i><span>Google Pay</span>
                </div>
                <div class="p-tab" onclick="selectPayment('paypal', this)">
                    <i class="fa-brands fa-paypal"></i><span>PayPal</span>
                </div>
            </div>

            <div id="card-content" class="payment-content active">
                
                {% if saved_methods %}
                    <label class="form-label">Select Saved Card</label>
                    {% for pm in saved_methods %}
                    <label class="saved-card-option">
                        <input type="radio" name="card_choice" value="saved" onchange="toggleNewCard(false)" {% if loop.first %}checked{% endif %}>
                        <input type="hidden" name="saved_pm_id" value="{{ pm.id }}"> <i class="fa-brands fa-cc-{{ pm.card_type|lower }} fa-lg"></i>
                        <span style="font-size: 14px; font-weight: 600;">{{ pm.card_type }} ending in {{ pm.last4 }}</span>
                        <span style="font-size: 12px; color: #666; margin-left: auto;">Exp: {{ pm.expiry }}</span>
                    </label>
                    {% endfor %}
                    
                    <label class="saved-card-option">
                        <input type="radio" name="card_choice" value="new" onchange="toggleNewCard(true)" id="useNewCardRadio">
                        <span style="font-size: 14px; font-weight: 600;">Use a different card</span>
                    </label>
                {% else %}
                    <input type="hidden" name="card_choice" value="new">
                {% endif %}

                <div id="newCardForm" style="{% if saved_methods %}display: none;{% endif %} margin-top: 20px; background: #fcfcfc; padding: 20px; border-radius: 6px; border: 1px dashed #ccc;">
                    <div class="form-group">
                        <label class="form-label">Cardholder Name</label>
                        <input type="text" name="card_name" class="form-input" placeholder="Name on Card">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Card Number</label>
                        <div style="position: relative;">
                            <input type="text" name="card_number" class="form-input" placeholder="0000 0000 0000 0000" maxlength="19">
                            <i class="fa-regular fa-credit-card" style="position: absolute; right: 14px; top: 16px; color: #999;"></i>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Expiry (MM/YY)</label><input type="text" name="expiry" class="form-input" placeholder="MM/YY" maxlength="5"></div>
                        <div class="form-group"><label class="form-label">CVC</label><input type="text" name="cvc" class="form-input" placeholder="123" maxlength="4"></div>
                    </div>
                </div>
            </div>

            <div id="apple-content" class="payment-content" style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: 8px;">
                <i class="fa-brands fa-apple" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>You will be redirected to Apple Pay to complete your purchase secureley.</p>
            </div>
            <div id="google-content" class="payment-content" style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: 8px;">
                <i class="fa-brands fa-google" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>Redirecting to Google Pay...</p>
            </div>
            <div id="paypal-content" class="payment-content" style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: 8px;">
                <i class="fa-brands fa-paypal" style="font-size: 40px; margin-bottom: 10px; color: #003087;"></i>
                <p>Log in to your PayPal account to finish paying.</p>
            </div>

            <button type="submit" class="btn-pay">Place Order (${{ "%.2f"|format(totals.grand_total) }})</button>
            <div class="secure-badge"><i class="fa-solid fa-lock"></i> SSL Secured Checkout</div>
        </form>
    </div>

    <div class="order-summary">
        <h3 style="font-size: 16px; font-weight: 800; text-transform: uppercase; margin-bottom: 25px;">Order Summary</h3>
        {% for p_id, item in session.cart.items() %}
        <div style="display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #f5f5f5; padding-bottom: 20px;">
            <div style="width: 60px; height: 70px; background: #f4f4f5; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                <img src="{{ item.image }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: 700; margin-bottom: 4px;">{{ item.name }}</div>
                <div style="font-size: 12px; color: #777;">Qty: {{ item.qty }}</div>
            </div>
            <div style="font-size: 13px; font-weight: 600;">${{ "%.2f"|format(item.price * item.qty) }}</div>
        </div>
        {% endfor %}
        <div class="summary-total"><span>Total</span><span>${{ "%.2f"|format(totals.grand_total) }}</span></div>
    </div>
</div>

<script>
    function selectPayment(type, el) {
        document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('paymentTypeInput').value = type;
        
        document.querySelectorAll('.payment-content').forEach(c => c.classList.remove('active'));
        document.getElementById(type + '-content').classList.add('active');
    }
    
    function toggleNewCard(show) {
        document.getElementById('newCardForm').style.display = show ? 'block' : 'none';
        // Logic to disable specific saved ID inputs would go here in prod
    }
</script>
{% endblock %}