{% extends "store_base.html" %}
{% block content %}

<style>
    /* [KEEPING YOUR EXISTING LAYOUT] */
    .profile-container { max-width: 1200px; margin: 40px auto; padding: 0 40px; display: grid; grid-template-columns: 250px 1fr; gap: 40px; }
    .profile-sidebar { background: #f9f9f9; padding: 30px; border-radius: 8px; height: max-content; }
    
    /* UPDATED: Profile Picture & Upload Button */
    .profile-pic-container { 
        width: 100px; height: 100px; 
        background: #ddd; border-radius: 50%; 
        overflow: hidden; margin: 0 auto 15px; 
        position: relative; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .profile-pic-container img { width: 100%; height: 100%; object-fit: cover; }
    
    .profile-name { text-align: center; font-weight: 800; font-size: 18px; margin-bottom: 5px; }
    .profile-email { text-align: center; color: #666; font-size: 13px; margin-bottom: 25px; }
    
    /* PREMIUM UPLOAD BUTTON STYLE */
    .upload-wrapper { text-align: center; margin-bottom: 30px; }
    .btn-upload {
        display: inline-block; padding: 8px 16px; background: white; color: #333;
        border: 1px solid #ddd; border-radius: 20px; font-size: 11px; font-weight: 700;
        text-transform: uppercase; cursor: pointer; transition: all 0.2s;
    }
    .btn-upload:hover { background: #000; color: white; border-color: #000; }
    .btn-upload i { margin-right: 5px; }

    /* MENU BUTTONS */
    .profile-menu button { display: block; width: 100%; text-align: left; background: none; border: none; padding: 12px 0; font-size: 14px; font-weight: 600; color: #555; cursor: pointer; border-bottom: 1px solid #eee; transition: 0.2s; }
    .profile-menu button:hover, .profile-menu button.active { color: black; padding-left: 5px; }
    
    .btn-delete-sidebar { color: #dc2626 !important; margin-top: 10px; border-top: 1px solid #e5e5e5 !important; padding-top: 15px !important; }
    .btn-delete-sidebar:hover { background: #fee2e2 !important; }

    /* CONTENT SECTIONS */
    .profile-content { display: none; }
    .profile-content.active { display: block; }
    .section-title { font-size: 24px; font-weight: 800; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
    .form-group { flex: 1; }
    .form-label { display: block; font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; color: #333; }
    .form-input { width: 100%; padding: 14px; border: 1px solid #e5e5e5; border-radius: 4px; font-family: inherit; box-sizing: border-box; }
    .form-input.error { border-color: #dc2626; background-color: #fff5f5; }
    .error-msg { color: #dc2626; font-size: 11px; margin-top: 5px; display: none; font-weight: 600; }
    
    .btn-save { background: black; color: white; border: none; padding: 14px 30px; font-weight: 700; border-radius: 4px; cursor: pointer; }
    
    /* TABLES & BADGES */
    .invoice-table { width: 100%; border-collapse: collapse; }
    .invoice-table th { text-align: left; padding: 15px; border-bottom: 2px solid #eee; font-size: 12px; text-transform: uppercase; }
    .invoice-table td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .status-Paid { background: #dcfce7; color: #166534; }
    .status-Pending { background: #fef9c3; color: #854d0e; }
    
    /* --- NEW PAYMENT CARD STYLES --- */
    .saved-card-option { 
        border: 1px solid #e5e5e5; padding: 20px; border-radius: 6px; margin-bottom: 15px; 
        display: flex; align-items: center; gap: 15px; background: #fff; transition: 0.2s;
    }
    .saved-card-option:hover { border-color: #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .card-details { flex: 1; display: flex; align-items: center; gap: 10px; }
    .card-meta { font-size: 12px; color: #666; margin-left: auto; }
    .btn-delete-card { color: #dc2626; background: none; border: none; font-size: 12px; font-weight: 600; cursor: pointer; margin-left: 20px; padding: 5px 10px; border-radius: 4px; }
    .btn-delete-card:hover { background: #fee2e2; }

    /* --- MODAL STYLES --- */
    .modal-overlay { 
        position: fixed; top:0; left:0; width:100%; height:100%; 
        background: rgba(0,0,0,0.5); 
        display: flex; justify-content: center; align-items: center; 
        z-index: 1000; 
        opacity: 0; pointer-events: none; transition: opacity 0.2s; 
    }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    
    .modal-card { 
        background: white; padding: 30px; border-radius: 12px; width: 400px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        transform: translateY(10px); transition: transform 0.2s;
    }
    .modal-overlay.show .modal-card { transform: translateY(0); }
    
    .modal-icon { width: 50px; height: 50px; background: #fee2e2; color: #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; font-size: 20px; }
    .modal-icon.warning { background: #fef3c7; color: #d97706; }

    .modal-actions { display: flex; gap: 10px; margin-top: 25px; }
    .btn-cancel { flex: 1; padding: 12px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-danger { flex: 1; padding: 12px; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-danger:hover { background: #b91c1c; }
</style>

<div class="profile-container">
    <div class="profile-sidebar">
        <div class="profile-pic-container">
            {% if user.profile_image %}
                <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}" alt="Profile">
            {% else %}
                <img src="https://via.placeholder.com/100" alt="Profile">
            {% endif %}
        </div>
        
        <form action="{{ url_for('upload_profile_pic') }}" method="POST" enctype="multipart/form-data" id="avatarForm">
            <div class="upload-wrapper">
                <label for="file-upload" class="btn-upload">
                    <i class="fa-solid fa-camera"></i> Change Photo
                </label>
                <input id="file-upload" type="file" name="profile_pic" style="display:none;" onchange="document.getElementById('avatarForm').submit();"/>
            </div>
        </form>

        <div class="profile-name">{{ user.first_name }} {{ user.last_name }}</div>
        <div class="profile-email">{{ user.email }}</div>
        
        <div class="profile-menu">
            <button onclick="showSection('overview')" class="active">Profile Overview</button>
            <button onclick="showSection('orders')">Orders & Invoices</button>
            <button onclick="showSection('payment')">Payment Methods</button>
            <button onclick="showSection('security')">Security</button>
            
            <button onclick="toggleModal('logoutModal', true)" style="color: #dc2626;">
                Logout
            </button>
            
            <button onclick="toggleModal('deleteModal', true)" class="btn-delete-sidebar">
                Delete Account
            </button>
        </div>
    </div>

    <div id="overview" class="profile-content active">
        <h2 class="section-title">Profile Settings</h2>
        <form action="{{ url_for('update_profile') }}" method="POST">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" name="first_name" class="form-input" value="{{ user.first_name }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" name="last_name" class="form-input" value="{{ user.last_name }}">
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Phone Number</label>
                <input type="text" name="phone" class="form-input" value="{{ user.phone }}">
            </div>
            <button type="submit" class="btn-save">Save Changes</button>
        </form>
    </div>

    <div id="orders" class="profile-content">
        <h2 class="section-title">Order History & Invoices</h2>
        {% if invoices %}
        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for inv in invoices %}
                <tr>
                    <td>{{ inv.invoice_code }}</td>
                    <td>{{ inv.date_created.strftime('%b %d, %Y') }}</td>
                    <td>${{ "%.2f"|format(inv.amount) }}</td>
                    <td>
                        {% if inv.status == 'Pending' %}
                            <span class="status-badge status-Pending">Pending</span>
                        {% elif inv.status == 'Paid' %}
                            <span class="status-badge status-Paid">Paid</span>
                        {% elif inv.status == 'Cancelled' %}
                            <span class="status-badge" style="background: #fee2e2; color: #dc2626;">Cancelled</span>
                        {% else %}
                            <span class="status-badge" style="background: #f3f4f6; color: #666;">{{ inv.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if inv.status == 'Pending' %}
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <a href="{{ url_for('store_invoice_pay', invoice_id=inv.id) }}" class="btn-save" style="padding: 6px 12px; font-size: 11px; text-decoration: none; white-space: nowrap;">
                                    Pay Now
                                </a>
                                
                                <a href="{{ url_for('view_invoice', invoice_id=inv.id) }}" target="_blank" style="font-size: 12px; font-weight: 600; color: #333; text-decoration: underline;">
                                    View
                                </a>

                                <button onclick="openCancelOrderModal('{{ url_for('store_invoice_cancel', invoice_id=inv.id) }}')" style="background: none; border: none; color: #dc2626; font-size: 12px; font-weight: 600; cursor: pointer; padding: 0;">
                                    Cancel
                                </button>
                            </div>
                        {% else %}
                            <a href="{{ url_for('view_invoice', invoice_id=inv.id) }}" target="_blank" style="text-decoration: underline; font-weight: 600;">View Invoice</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #999;">No orders found associated with this email.</p>
        {% endif %}
    </div>

    <div id="payment" class="profile-content">
        <h2 class="section-title">Payment Methods</h2>
        
        <div id="cards-container">
            {% if payment_methods %}
                {% for pm in payment_methods %}
                <div class="saved-card-option" id="card-{{ pm.id }}">
                    <div class="card-details">
                        <i class="fa-brands fa-cc-{{ pm.card_type|lower }} fa-lg" style="font-size: 24px; color: #333;"></i>
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-size: 14px; font-weight: 700;">{{ pm.card_type }} ending in {{ pm.last4 }}</span>
                            <span style="font-size: 12px; color: #777;">{{ pm.cardholder_name }}</span>
                        </div>
                    </div>
                    <div class="card-meta">Expires: {{ pm.expiry }}</div>
                    
                    <button type="button" class="btn-delete-card" onclick="openCardDeleteModal({{ pm.id }})">
                        <i class="fa-solid fa-trash"></i> Remove
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <div id="no-cards-msg" style="padding: 40px; text-align: center; background: #f9f9f9; border-radius: 6px; border: 1px dashed #ccc; margin-bottom: 30px;">
                    <i class="fa-regular fa-credit-card" style="font-size: 30px; color: #ccc; margin-bottom: 10px;"></i>
                    <p style="color: #999; font-size: 14px;">No payment methods saved.</p>
                </div>
            {% endif %}
        </div>

        <h3 style="font-size: 16px; margin-top: 40px; margin-bottom: 15px; font-weight: 700;">Add New Card</h3>
        
        <form action="{{ url_for('update_payment') }}" method="POST" id="paymentForm" novalidate>
            <div class="form-group" style="margin-bottom: 15px;">
                <label class="form-label">Cardholder Name</label>
                <input type="text" name="cardholder_name" class="form-input" placeholder="Name on Card" required>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label class="form-label">Card Number</label>
                <div style="position: relative;">
                    <input type="text" id="cardNumber" name="card_number" class="form-input" placeholder="0000 0000 0000 0000" maxlength="19" required>
                    <i class="fa-regular fa-credit-card" style="position: absolute; right: 14px; top: 16px; color: #999;"></i>
                </div>
                <div class="error-msg" id="cardError">Invalid card number</div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Expiry (MM/YY)</label>
                    <input type="text" id="expiryDate" name="expiry" class="form-input" placeholder="MM/YY" maxlength="5" required>
                    <div class="error-msg" id="expiryError">Invalid date</div>
                </div>
                <div class="form-group">
                    <label class="form-label">CVC (Not Saved)</label>
                    <input type="text" name="cvc" class="form-input" placeholder="123" maxlength="4" required pattern="\d*">
                </div>
            </div>
            <button type="submit" class="btn-save" id="saveCardBtn">Save Payment Method</button>
        </form>
    </div>

    <div id="security" class="profile-content">
        <h2 class="section-title">Security</h2>
        
        <div style="margin-bottom: 40px;">
            <h3 style="font-size: 16px; margin-bottom: 15px;">Change Password</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Requires verification via OTP.</p>
            
            <form action="{{ url_for('security_update') }}" method="POST">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">Current Password</label>
                    <input type="password" name="current_password" class="form-input" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">New Password</label>
                    <input type="password" name="new_password" class="form-input" required>
                </div>
                <button type="submit" class="btn-save">Verify & Change Password</button>
            </form>
        </div>

        <div>
            <h3 style="font-size: 16px; margin-bottom: 15px;">Change Email Address</h3>
            <form action="{{ url_for('request_email_change') }}" method="POST">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">New Email Address</label>
                    <input type="email" name="new_email" class="form-input" required placeholder="new@example.com">
                </div>
                <button type="submit" class="btn-save">Send OTP</button>
            </form>
        </div>
    </div>
</div>

<div id="logoutModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon warning"><i class="fa-solid fa-right-from-bracket"></i></div>
        <h3 style="margin-bottom: 10px; font-size: 18px;">Log Out?</h3>
        <p style="color: #666; font-size: 14px; line-height: 1.5;">Are you sure you want to end your session?</p>
        <div class="modal-actions">
            <button onclick="toggleModal('logoutModal', false)" class="btn-cancel">Cancel</button>
            <a href="{{ url_for('store_logout') }}" class="btn-danger" style="text-align: center; text-decoration: none;">Log Out</a>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
        <h3 style="margin-bottom: 10px; font-size: 18px;">Delete Account?</h3>
        <p style="color: #666; font-size: 14px; line-height: 1.5;">This action cannot be undone. All your data and order history will be permanently removed.</p>
        <div class="modal-actions">
            <button onclick="toggleModal('deleteModal', false)" class="btn-cancel">Cancel</button>
            <form action="{{ url_for('delete_account') }}" method="POST" style="flex: 1;">
                <button type="submit" class="btn-danger" style="width: 100%;">Delete Account</button>
            </form>
        </div>
    </div>
</div>

<div id="deleteCardModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon"><i class="fa-regular fa-credit-card"></i></div>
        <h3 style="margin-bottom: 10px; font-size: 18px;">Remove Payment Method?</h3>
        <p style="color: #666; font-size: 14px; line-height: 1.5;">Are you sure you want to remove this card? You will need to add it again for future purchases.</p>
        <div class="modal-actions">
            <button onclick="toggleModal('deleteCardModal', false)" class="btn-cancel">Cancel</button>
            <button id="confirmDeleteCardBtn" type="button" class="btn-danger" style="width: 100%;">Remove Card</button>
        </div>
    </div>
</div>

<div id="cancelOrderModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon warning"><i class="fa-solid fa-ban"></i></div>
        <h3 style="margin-bottom: 10px; font-size: 18px;">Cancel Invoice?</h3>
        <p style="color: #666; font-size: 14px; line-height: 1.5;">Are you sure you want to cancel this pending invoice? The items will be returned to stock.</p>
        <div class="modal-actions">
            <button onclick="toggleModal('cancelOrderModal', false)" class="btn-cancel">Keep Order</button>
            <a id="confirmCancelOrderBtn" href="#" class="btn-danger" style="text-align: center; text-decoration: none;">Yes, Cancel Invoice</a>
        </div>
    </div>
</div>

<script>
    function showSection(sectionId) {
        document.querySelectorAll('.profile-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.profile-menu button').forEach(el => el.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        event.target.classList.add('active');
    }

    // --- MODAL LOGIC ---
    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (show) modal.classList.add('show');
        else modal.classList.remove('show');
    }

    // Open Delete Card Modal and bind ID
    let cardToDeleteId = null;
    function openCardDeleteModal(id) {
        cardToDeleteId = id;
        toggleModal('deleteCardModal', true);
    }

    // NEW: Open Cancel Order Modal
    function openCancelOrderModal(url) {
        document.getElementById('confirmCancelOrderBtn').href = url;
        toggleModal('cancelOrderModal', true);
    }

    // --- DOM READY ---
    document.addEventListener('DOMContentLoaded', function() {
        const cardInput = document.getElementById('cardNumber');
        const expiryInput = document.getElementById('expiryDate');
        const form = document.getElementById('paymentForm');

        // 1. Formatting Logic (Same as before)
        if (cardInput) {
            cardInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); 
                value = value.substring(0, 16); 
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
        }
        if (expiryInput) {
            expiryInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); 
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }

        // 2. AJAX ADD CARD
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // STOP REFRESH

                let isValid = true;
                const cardVal = cardInput.value.replace(/\s/g, '');
                const expiryVal = expiryInput.value;

                // Client-side Validation
                document.querySelectorAll('.form-input').forEach(i => i.classList.remove('error'));
                document.querySelectorAll('.error-msg').forEach(m => m.style.display = 'none');

                if (!luhnCheck(cardVal)) {
                    document.getElementById('cardError').style.display = 'block';
                    cardInput.classList.add('error');
                    isValid = false;
                }
                if (!validateExpiry(expiryVal)) {
                    document.getElementById('expiryError').style.display = 'block';
                    expiryInput.classList.add('error');
                    isValid = false;
                }

                if (isValid) {
                    const btn = document.getElementById('saveCardBtn');
                    const originalText = btn.innerText;
                    btn.innerText = "Adding...";
                    btn.disabled = true;

                    const formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addCardToDOM(data.card);
                            form.reset();
                            // Optional: Show a toast here
                        } else {
                            alert(data.message || "Error adding card");
                        }
                    })
                    .catch(error => console.error('Error:', error))
                    .finally(() => {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    });
                }
            });
        }

        // 3. AJAX DELETE CARD
        const confirmDeleteBtn = document.getElementById('confirmDeleteCardBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function() {
                if (!cardToDeleteId) return;

                const originalText = confirmDeleteBtn.innerText;
                confirmDeleteBtn.innerText = "Removing...";
                confirmDeleteBtn.disabled = true;

                fetch("{{ url_for('store_profile') }}/delete_payment/" + cardToDeleteId, {
                    method: 'POST', // or DELETE if your server supports it
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const el = document.getElementById('card-' + cardToDeleteId);
                        if (el) el.remove();
                        checkNoCards();
                        toggleModal('deleteCardModal', false);
                    }
                })
                .finally(() => {
                    confirmDeleteBtn.innerText = originalText;
                    confirmDeleteBtn.disabled = false;
                });
            });
        }
    });

    // Helper: Add Card to DOM
    function addCardToDOM(card) {
        const container = document.getElementById('cards-container');
        const noCardsMsg = document.getElementById('no-cards-msg');
        if (noCardsMsg) noCardsMsg.remove();

        const html = `
        <div class="saved-card-option" id="card-${card.id}">
            <div class="card-details">
                <i class="fa-brands fa-cc-${card.card_type.toLowerCase()} fa-lg" style="font-size: 24px; color: #333;"></i>
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 14px; font-weight: 700;">${card.card_type} ending in ${card.last4}</span>
                    <span style="font-size: 12px; color: #777;">${card.cardholder_name}</span>
                </div>
            </div>
            <div class="card-meta">Expires: ${card.expiry}</div>
            <button type="button" class="btn-delete-card" onclick="openCardDeleteModal(${card.id})">
                <i class="fa-solid fa-trash"></i> Remove
            </button>
        </div>`;
        
        // Append as proper DOM element
        container.insertAdjacentHTML('beforeend', html);
    }

    // Helper: Check if empty
    function checkNoCards() {
        const container = document.getElementById('cards-container');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div id="no-cards-msg" style="padding: 40px; text-align: center; background: #f9f9f9; border-radius: 6px; border: 1px dashed #ccc; margin-bottom: 30px;">
                    <i class="fa-regular fa-credit-card" style="font-size: 30px; color: #ccc; margin-bottom: 10px;"></i>
                    <p style="color: #999; font-size: 14px;">No payment methods saved.</p>
                </div>`;
        }
    }

    function luhnCheck(val) {
        if (/[^0-9-\s]+/.test(val)) return false;
        let nCheck = 0, bEven = false;
        val = val.replace(/\D/g, "");
        if (val.length < 13) return false; 
        for (var n = val.length - 1; n >= 0; n--) {
            var cDigit = val.charAt(n), nDigit = parseInt(cDigit, 10);
            if (bEven && (nDigit *= 2) > 9) nDigit -= 9;
            nCheck += nDigit;
            bEven = !bEven;
        }
        return (nCheck % 10) == 0;
    }

    function validateExpiry(val) {
        if (!/^\d{2}\/\d{2}$/.test(val)) return false;
        const parts = val.split('/');
        const month = parseInt(parts[0], 10);
        const year = parseInt("20" + parts[1], 10);
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        if (month < 1 || month > 12) return false; 
        if (year < currentYear) return false; 
        if (year === currentYear && month < currentMonth) return false; 
        return true;
    }
</script>
{% endblock %}