{% extends "store_base.html" %}
{% block content %}

<style>
    /* --- CORE LAYOUT --- */
    /* UPDATED: Made wider (1400px) for a more premium, dashboard feel */
    .profile-container { 
        max-width: 1400px; 
        margin: 60px auto; 
        padding: 0 40px; 
        display: grid; 
        grid-template-columns: 280px 1fr; /* Slightly wider sidebar */
        gap: 60px; 
        min-height: 60vh; /* Ensures footer doesn't jump up on empty pages */
    }
    
    /* --- SIDEBAR --- */
    .profile-sidebar { 
        padding: 40px 30px; 
        border-right: 1px solid #eee; /* Clean divider instead of background box */
        height: max-content; 
    }
    
    .profile-pic-container { 
        width: 120px; height: 120px; 
        background: #f4f4f5; border-radius: 50%; 
        overflow: hidden; margin: 0 auto 20px; 
        position: relative; 
        border: 1px solid #e5e5e5;
    }
    .profile-pic-container img { width: 100%; height: 100%; object-fit: cover; }
    
    .profile-name { text-align: center; font-weight: 800; font-size: 20px; margin-bottom: 5px; letter-spacing: -0.5px; }
    .profile-email { text-align: center; color: #71717a; font-size: 13px; margin-bottom: 30px; font-weight: 500; }
    
    .upload-wrapper { text-align: center; margin-bottom: 40px; }
    .btn-upload {
        display: inline-block; padding: 10px 20px; background: white; color: #111;
        border: 1px solid #e5e5e5; border-radius: 30px; font-size: 11px; font-weight: 700;
        text-transform: uppercase; cursor: pointer; transition: all 0.2s ease; letter-spacing: 0.5px;
    }
    .btn-upload:hover { border-color: #000; transform: translateY(-1px); }
    .btn-upload i { margin-right: 6px; }

    /* MENU ITEMS */
    .profile-menu button { 
        display: flex; align-items: center; justify-content: space-between;
        width: 100%; text-align: left; background: none; border: none; 
        padding: 16px 0; font-size: 14px; font-weight: 600; color: #71717a; 
        cursor: pointer; border-bottom: 1px solid #f4f4f5; transition: 0.2s; 
    }
    .profile-menu button:hover, .profile-menu button.active { color: #000; padding-left: 10px; }
    .profile-menu button::after { content: 'â†’'; opacity: 0; transition: 0.2s; }
    .profile-menu button:hover::after, .profile-menu button.active::after { opacity: 1; }
    
    .btn-delete-sidebar { color: #ef4444 !important; margin-top: 20px; border-top: 1px solid #f4f4f5 !important; padding-top: 20px !important; }
    .btn-delete-sidebar:hover { background: #fef2f2 !important; padding-left: 10px; }

    /* --- CONTENT AREA --- */
    .profile-content { display: none; opacity: 0; animation: fadeIn 0.4s ease forwards; }
    .profile-content.active { display: block; }
    @keyframes fadeIn { to { opacity: 1; } }

    .section-title { font-size: 28px; font-weight: 900; margin-bottom: 40px; letter-spacing: -1px; }
    
    /* --- FORMS & INPUTS --- */
    .form-row { display: flex; gap: 30px; margin-bottom: 25px; }
    .form-group { flex: 1; margin-bottom: 25px; }
    .form-label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; color: #111; letter-spacing: 0.5px; }
    .form-input { 
        width: 100%; padding: 16px; border: 1px solid #e5e5e5; 
        border-radius: 6px; font-family: inherit; font-size: 14px; 
        box-sizing: border-box; transition: 0.2s; background: #fff;
    }
    .form-input:focus { border-color: #000; outline: none; }
    .form-input.error { border-color: #ef4444; background-color: #fef2f2; }
    .error-msg { color: #ef4444; font-size: 11px; margin-top: 6px; display: none; font-weight: 600; }
    
    .btn-save { 
        background: #000; color: white; border: none; 
        padding: 16px 36px; font-weight: 700; font-size: 12px; 
        text-transform: uppercase; letter-spacing: 1px;
        border-radius: 4px; cursor: pointer; transition: 0.2s; 
    }
    .btn-save:hover { opacity: 0.8; }
    .btn-save:disabled { background: #e5e5e5; color: #a1a1aa; cursor: not-allowed; opacity: 1; }

    /* --- NEW SECURITY GRID (PREMIUM LOOK) --- */
    .security-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 40px;
    }
    .security-card {
        border: 1px solid #e5e5e5;
        padding: 40px;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: #fff;
    }
    .security-card:hover {
        border-color: #000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.03);
        transform: translateY(-2px);
    }
    .card-header h3 { margin: 0 0 10px 0; font-size: 18px; font-weight: 800; }
    .card-header p { margin: 0 0 30px 0; font-size: 13px; color: #71717a; line-height: 1.5; }

    /* --- TABLES & BADGES --- */
    .invoice-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .invoice-table th { text-align: left; padding: 20px; border-bottom: 2px solid #f4f4f5; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #71717a; }
    .invoice-table td { padding: 20px; border-bottom: 1px solid #f4f4f5; font-size: 14px; font-weight: 500; }
    .status-badge { padding: 6px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-Paid { background: #dcfce7; color: #166534; }
    .status-Pending { background: #fef9c3; color: #854d0e; }
    
    /* --- SAVED CARDS --- */
    .saved-card-option { 
        border: 1px solid #e5e5e5; padding: 25px; border-radius: 8px; margin-bottom: 20px; 
        display: flex; align-items: center; gap: 20px; background: #fff; transition: 0.2s;
    }
    .saved-card-option:hover { border-color: #000; }
    .card-details { flex: 1; display: flex; align-items: center; gap: 15px; }
    .card-meta { font-size: 12px; color: #71717a; font-weight: 500; margin-left: auto; }
    .btn-delete-card { color: #ef4444; background: none; border: none; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; margin-left: 30px; padding: 8px 12px; border-radius: 4px; transition: 0.2s; }
    .btn-delete-card:hover { background: #fef2f2; }

    /* --- MODALS --- */
    .modal-overlay { 
        position: fixed; top:0; left:0; width:100%; height:100%; 
        background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        display: flex; justify-content: center; align-items: center; 
        z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; 
    }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    
    .modal-card { 
        background: white; padding: 40px; border-radius: 16px; width: 420px; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.15); 
        transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .modal-overlay.show .modal-card { transform: translateY(0); }
    
    .modal-icon { width: 60px; height: 60px; background: #fef2f2; color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 25px; font-size: 24px; }
    .modal-icon.warning { background: #fefce8; color: #ca8a04; }

    .modal-actions { display: flex; gap: 15px; margin-top: 30px; }
    .btn-cancel { flex: 1; padding: 14px; background: #f4f4f5; color: #18181b; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-cancel:hover { background: #e4e4e7; }
    .btn-danger { flex: 1; padding: 14px; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-danger:hover { background: #dc2626; }

    /* --- PASSWORD REQUIREMENTS --- */
    .req-list { list-style: none; padding: 0; margin-top: 15px; font-size: 11px; color: #71717a; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .req-item { display: flex; align-items: center; gap: 8px; transition: color 0.2s; font-weight: 500; }
    .req-item i { font-size: 6px; color: #d4d4d8; }
    .valid { color: #15803d; }
    .valid i { color: #15803d; font-size: 10px; }
    .invalid { color: #ef4444; }

    /* Responsive */
    @media(max-width: 1000px) {
        .profile-container { grid-template-columns: 1fr; padding: 0 20px; }
        .profile-sidebar { border-right: none; border-bottom: 1px solid #eee; }
    }
</style>

<div class="profile-container">
    <div class="profile-sidebar">
        <div class="profile-pic-container">
            {% if user.profile_image and user.profile_image != 'default.jpg' %}
                <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}" alt="Profile">
            {% else %}
                <img src="{{ url_for('static', filename='images/default.jpg') }}" alt="Profile">
            {% endif %}
        </div>
        
        <form action="{{ url_for('upload_profile_pic') }}" method="POST" enctype="multipart/form-data" id="avatarForm">
            <div class="upload-wrapper">
                <label for="file-upload" class="btn-upload">
                    <i class="fa-solid fa-camera"></i> Change Photo
                </label>
                <input id="file-upload" type="file" name="profile_pic" style="display:none;" onchange="document.getElementById('avatarForm').submit();"/>
            </div>
        </form>

        <div class="profile-name">{{ user.first_name }} {{ user.last_name }}</div>
        <div class="profile-email">{{ user.email }}</div>
        
        <div class="profile-menu">
            <button onclick="showSection('overview')" class="active">Profile Overview</button>
            <button onclick="showSection('orders')">Orders & Invoices</button>
            <button onclick="showSection('payment')">Payment Methods</button>
            <button onclick="showSection('security')">Security Settings</button>
            
            <button onclick="toggleModal('logoutModal', true)" style="color: #ef4444;">Logout</button>
            <button onclick="toggleModal('deleteModal', true)" class="btn-delete-sidebar">Delete Account</button>
        </div>
    </div>

    <div id="overview" class="profile-content active">
        <h2 class="section-title">Profile Settings</h2>
        <form action="{{ url_for('update_profile') }}" method="POST" style="max-width: 600px;">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" name="first_name" class="form-input" value="{{ user.first_name }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" name="last_name" class="form-input" value="{{ user.last_name }}">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input type="text" name="phone" class="form-input" value="{{ user.phone }}">
            </div>
            <div style="margin-top: 40px;">
                <button type="submit" class="btn-save">Save Changes</button>
            </div>
        </form>
    </div>

    <div id="orders" class="profile-content">
        <h2 class="section-title">Order History</h2>
        {% if invoices %}
        <div style="overflow-x: auto;">
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in invoices %}
                    <tr>
                        <td>{{ inv.invoice_code }}</td>
                        <td>{{ inv.date_created.strftime('%b %d, %Y') }}</td>
                        <td>${{ "%.2f"|format(inv.amount) }}</td>
                        <td>
                            {% if inv.status == 'Pending' %}
                                <span class="status-badge status-Pending">Pending</span>
                            {% elif inv.status == 'Paid' %}
                                <span class="status-badge status-Paid">Paid</span>
                            {% elif inv.status == 'Cancelled' %}
                                <span class="status-badge" style="background: #fef2f2; color: #ef4444;">Cancelled</span>
                            {% else %}
                                <span class="status-badge" style="background: #f4f4f5; color: #52525b;">{{ inv.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if inv.status == 'Pending' %}
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <a href="{{ url_for('store_invoice_pay', invoice_id=inv.id) }}" class="btn-save" style="padding: 8px 16px; font-size: 10px; text-decoration: none; white-space: nowrap;">
                                        Pay
                                    </a>
                                    <a href="{{ url_for('view_invoice', invoice_id=inv.id) }}" target="_blank" style="font-size: 12px; font-weight: 700; color: #111; text-decoration: underline;">View</a>
                                    <button onclick="openCancelOrderModal('{{ url_for('store_invoice_cancel', invoice_id=inv.id) }}')" style="background: none; border: none; color: #ef4444; font-size: 12px; font-weight: 700; cursor: pointer; padding: 0;">
                                        Cancel
                                    </button>
                                </div>
                            {% else %}
                                <a href="{{ url_for('view_invoice', invoice_id=inv.id) }}" target="_blank" style="text-decoration: underline; font-weight: 600; color: #555; font-size: 13px;">Download Invoice</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="padding: 60px; text-align: center; border: 1px dashed #e5e5e5; border-radius: 8px;">
            <i class="fa-solid fa-bag-shopping" style="font-size: 32px; color: #e5e5e5; margin-bottom: 15px;"></i>
            <p style="color: #71717a; font-size: 14px;">No orders found associated with this account.</p>
            <a href="{{ url_for('store_shop') }}" class="btn-save" style="display: inline-block; margin-top: 20px; text-decoration: none;">Start Shopping</a>
        </div>
        {% endif %}
    </div>

    <div id="payment" class="profile-content">
        <h2 class="section-title">Payment Methods</h2>
        
        <div id="cards-container">
            {% if payment_methods %}
                {% for pm in payment_methods %}
                <div class="saved-card-option" id="card-{{ pm.id }}">
                    <div class="card-details">
                        <i class="fa-brands fa-cc-{{ pm.card_type|lower }} fa-lg" style="font-size: 28px; color: #111;"></i>
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-size: 14px; font-weight: 700;">{{ pm.card_type }} ending in {{ pm.last4 }}</span>
                            <span style="font-size: 12px; color: #71717a;">{{ pm.cardholder_name }}</span>
                        </div>
                    </div>
                    <div class="card-meta">Expires: {{ pm.expiry }}</div>
                    <button type="button" class="btn-delete-card" onclick="openCardDeleteModal({{ pm.id }})">
                        Remove
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <div id="no-cards-msg" style="padding: 40px; text-align: center; background: #f9f9f9; border-radius: 8px; border: 1px dashed #e5e5e5; margin-bottom: 30px;">
                    <i class="fa-regular fa-credit-card" style="font-size: 30px; color: #d4d4d8; margin-bottom: 10px;"></i>
                    <p style="color: #a1a1aa; font-size: 13px;">No payment methods saved.</p>
                </div>
            {% endif %}
        </div>

        <h3 style="font-size: 15px; margin-top: 50px; margin-bottom: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Add New Card</h3>
        
        <form action="{{ url_for('update_payment') }}" method="POST" id="paymentForm" novalidate style="max-width: 500px;">
            <div class="form-group">
                <label class="form-label">Cardholder Name</label>
                <input type="text" name="cardholder_name" class="form-input" placeholder="Name on Card" required>
            </div>

            <div class="form-group">
                <label class="form-label">Card Number</label>
                <div style="position: relative;">
                    <input type="text" id="cardNumber" name="card_number" class="form-input" placeholder="0000 0000 0000 0000" maxlength="19" required>
                    <i class="fa-regular fa-credit-card" style="position: absolute; right: 14px; top: 16px; color: #a1a1aa;"></i>
                </div>
                <div class="error-msg" id="cardError">Invalid card number</div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Expiry</label>
                    <input type="text" id="expiryDate" name="expiry" class="form-input" placeholder="MM/YY" maxlength="5" required>
                    <div class="error-msg" id="expiryError">Invalid date</div>
                </div>
                <div class="form-group">
                    <label class="form-label">CVC</label>
                    <input type="text" name="cvc" class="form-input" placeholder="123" maxlength="4" required pattern="\d*">
                </div>
            </div>
            <button type="submit" class="btn-save" id="saveCardBtn">Save Payment Method</button>
        </form>
    </div>

    <div id="security" class="profile-content">
        <h2 class="section-title">Security Settings</h2>
        
        <div class="security-grid">
            
            <div class="security-card">
                <div class="card-header">
                    <h3>Change Password</h3>
                    <p>Update your password associated with this account. Requires verification.</p>
                </div>
                
                <form action="{{ url_for('security_update') }}" method="POST">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" name="current_password" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="new_password" name="new_password" class="form-input" required placeholder="Min 8 chars, mixed case, symbol">
                        
                        <ul class="req-list">
                            <li id="p-req-len" class="req-item"><i class="fa-solid fa-circle"></i> 8+ Chars</li>
                            <li id="p-req-upper" class="req-item"><i class="fa-solid fa-circle"></i> Uppercase</li>
                            <li id="p-req-lower" class="req-item"><i class="fa-solid fa-circle"></i> Lowercase</li>
                            <li id="p-req-num" class="req-item"><i class="fa-solid fa-circle"></i> Number</li>
                            <li id="p-req-sym" class="req-item"><i class="fa-solid fa-circle"></i> Symbol</li>
                        </ul>
                    </div>
                    
                    <button type="submit" id="change_password_btn" class="btn-save" style="width:100%" disabled>Update Password</button>
                </form>
            </div>

            <div class="security-card">
                <div class="card-header">
                    <h3>Email Address</h3>
                    <p>Change your login email. We will send an OTP to your current email to verify.</p>
                </div>
                
                <form action="{{ url_for('request_email_change') }}" method="POST">
                    <div class="form-group">
                        <label class="form-label">Current Email</label>
                        <input type="text" class="form-input" value="{{ user.email }}" disabled style="background: #f9f9f9; color: #666;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">New Email Address</label>
                        <input type="email" name="new_email" class="form-input" required placeholder="new@example.com">
                    </div>
                    
                    <button type="submit" class="btn-save" style="width:100%">Send Verification Code</button>
                </form>
            </div>

        </div>
    </div> </div> <div id="logoutModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon warning"><i class="fa-solid fa-right-from-bracket"></i></div>
        <h3 style="margin: 0 0 10px 0; font-size: 20px; font-weight: 800; text-align: center;">Log Out?</h3>
        <p style="color: #666; font-size: 14px; line-height: 1.5; text-align: center; margin: 0;">Are you sure you want to end your session?</p>
        <div class="modal-actions">
            <button onclick="toggleModal('logoutModal', false)" class="btn-cancel">Cancel</button>
            <a href="{{ url_for('store_logout') }}" class="btn-danger" style="text-align: center; text-decoration: none; line-height: 1.2;">Log Out</a>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
        <h3 style="margin: 0 0 10px 0; font-size: 20px; font-weight: 800; text-align: center;">Delete Account?</h3>
        <p style="color: #666; font-size: 14px; line-height: 1.5; text-align: center; margin: 0;">This action cannot be undone. All your data will be permanently removed.</p>
        <div class="modal-actions">
            <button onclick="toggleModal('deleteModal', false)" class="btn-cancel">Cancel</button>
            <form action="{{ url_for('delete_account') }}" method="POST" style="flex: 1; display:flex;">
                <button type="submit" class="btn-danger" style="width: 100%;">Delete Account</button>
            </form>
        </div>
    </div>
</div>

<div id="deleteCardModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon"><i class="fa-regular fa-credit-card"></i></div>
        <h3 style="margin: 0 0 10px 0; font-size: 20px; font-weight: 800; text-align: center;">Remove Card?</h3>
        <p style="color: #666; font-size: 14px; line-height: 1.5; text-align: center; margin: 0;">You will need to add this payment method again for future purchases.</p>
        <div class="modal-actions">
            <button onclick="toggleModal('deleteCardModal', false)" class="btn-cancel">Cancel</button>
            <button id="confirmDeleteCardBtn" type="button" class="btn-danger" style="width: 100%;">Remove Card</button>
        </div>
    </div>
</div>

<div id="cancelOrderModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon warning"><i class="fa-solid fa-ban"></i></div>
        <h3 style="margin: 0 0 10px 0; font-size: 20px; font-weight: 800; text-align: center;">Cancel Invoice?</h3>
        <p style="color: #666; font-size: 14px; line-height: 1.5; text-align: center; margin: 0;">This pending invoice will be cancelled and items returned to stock.</p>
        <div class="modal-actions">
            <button onclick="toggleModal('cancelOrderModal', false)" class="btn-cancel">Keep Order</button>
            <a id="confirmCancelOrderBtn" href="#" class="btn-danger" style="text-align: center; text-decoration: none; line-height: 1.2;">Yes, Cancel</a>
        </div>
    </div>
</div>

<script>
    function showSection(sectionId) {
        document.querySelectorAll('.profile-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.profile-menu button').forEach(el => el.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        event.target.classList.add('active');
    }

    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (show) modal.classList.add('show');
        else modal.classList.remove('show');
    }

    let cardToDeleteId = null;
    function openCardDeleteModal(id) {
        cardToDeleteId = id;
        toggleModal('deleteCardModal', true);
    }

    function openCancelOrderModal(url) {
        document.getElementById('confirmCancelOrderBtn').href = url;
        toggleModal('cancelOrderModal', true);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. PAYMENT FORMATTING & ADD ---
        const cardInput = document.getElementById('cardNumber');
        const expiryInput = document.getElementById('expiryDate');
        const form = document.getElementById('paymentForm');

        if (cardInput) {
            cardInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); 
                value = value.substring(0, 16); 
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
        }
        if (expiryInput) {
            expiryInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); 
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }

        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); 
                let isValid = true;
                const cardVal = cardInput.value.replace(/\s/g, '');
                const expiryVal = expiryInput.value;

                document.querySelectorAll('.form-input').forEach(i => i.classList.remove('error'));
                document.querySelectorAll('.error-msg').forEach(m => m.style.display = 'none');

                if (!luhnCheck(cardVal)) {
                    document.getElementById('cardError').style.display = 'block';
                    cardInput.classList.add('error');
                    isValid = false;
                }
                if (!validateExpiry(expiryVal)) {
                    document.getElementById('expiryError').style.display = 'block';
                    expiryInput.classList.add('error');
                    isValid = false;
                }

                if (isValid) {
                    const btn = document.getElementById('saveCardBtn');
                    const originalText = btn.innerText;
                    btn.innerText = "Adding...";
                    btn.disabled = true;

                    const formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addCardToDOM(data.card);
                            form.reset();
                        } else {
                            alert(data.message || "Error adding card");
                        }
                    })
                    .catch(error => console.error('Error:', error))
                    .finally(() => {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    });
                }
            });
        }

        // --- 2. DELETE CARD ---
        const confirmDeleteBtn = document.getElementById('confirmDeleteCardBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function() {
                if (!cardToDeleteId) return;
                const originalText = confirmDeleteBtn.innerText;
                confirmDeleteBtn.innerText = "Removing...";
                confirmDeleteBtn.disabled = true;

                fetch("{{ url_for('store_profile') }}/delete_payment/" + cardToDeleteId, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const el = document.getElementById('card-' + cardToDeleteId);
                        if (el) el.remove();
                        checkNoCards();
                        toggleModal('deleteCardModal', false);
                    }
                })
                .finally(() => {
                    confirmDeleteBtn.innerText = originalText;
                    confirmDeleteBtn.disabled = false;
                });
            });
        }

        // --- 3. PASSWORD VALIDATION ---
        const newPwInput = document.getElementById('new_password');
        const pwBtn = document.getElementById('change_password_btn');
        
        if(newPwInput && pwBtn){
            const reqs = {
                len: document.getElementById('p-req-len'),
                upper: document.getElementById('p-req-upper'),
                lower: document.getElementById('p-req-lower'),
                num: document.getElementById('p-req-num'),
                sym: document.getElementById('p-req-sym')
            };

            function validateProfilePw(){
                const val = newPwInput.value;
                const checks = {
                    len: val.length >= 8,
                    upper: /[A-Z]/.test(val),
                    lower: /[a-z]/.test(val),
                    num: /\d/.test(val),
                    sym: /[\W_]/.test(val)
                };

                updateReq(reqs.len, checks.len);
                updateReq(reqs.upper, checks.upper);
                updateReq(reqs.lower, checks.lower);
                updateReq(reqs.num, checks.num);
                updateReq(reqs.sym, checks.sym);

                pwBtn.disabled = !Object.values(checks).every(Boolean);
            }

            function updateReq(el, valid){
                const icon = el.querySelector('i');
                if(valid){
                    el.classList.add('valid');
                    el.classList.remove('invalid');
                    icon.className = 'fa-solid fa-check';
                } else {
                    el.classList.remove('valid');
                    icon.className = 'fa-solid fa-circle';
                }
            }

            newPwInput.addEventListener('input', validateProfilePw);
        }
    });

    // Helpers
    function addCardToDOM(card) {
        const container = document.getElementById('cards-container');
        const noCardsMsg = document.getElementById('no-cards-msg');
        if (noCardsMsg) noCardsMsg.remove();

        const html = `
        <div class="saved-card-option" id="card-${card.id}">
            <div class="card-details">
                <i class="fa-brands fa-cc-${card.card_type.toLowerCase()} fa-lg" style="font-size: 28px; color: #111;"></i>
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 14px; font-weight: 700;">${card.card_type} ending in ${card.last4}</span>
                    <span style="font-size: 12px; color: #71717a;">${card.cardholder_name}</span>
                </div>
            </div>
            <div class="card-meta">Expires: ${card.expiry}</div>
            <button type="button" class="btn-delete-card" onclick="openCardDeleteModal(${card.id})">
                Remove
            </button>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    function checkNoCards() {
        const container = document.getElementById('cards-container');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div id="no-cards-msg" style="padding: 40px; text-align: center; background: #f9f9f9; border-radius: 8px; border: 1px dashed #e5e5e5; margin-bottom: 30px;">
                    <i class="fa-regular fa-credit-card" style="font-size: 30px; color: #d4d4d8; margin-bottom: 10px;"></i>
                    <p style="color: #a1a1aa; font-size: 13px;">No payment methods saved.</p>
                </div>`;
        }
    }

    function luhnCheck(val) {
        if (/[^0-9-\s]+/.test(val)) return false;
        let nCheck = 0, bEven = false;
        val = val.replace(/\D/g, "");
        if (val.length < 13) return false; 
        for (var n = val.length - 1; n >= 0; n--) {
            var cDigit = val.charAt(n), nDigit = parseInt(cDigit, 10);
            if (bEven && (nDigit *= 2) > 9) nDigit -= 9;
            nCheck += nDigit;
            bEven = !bEven;
        }
        return (nCheck % 10) == 0;
    }

    function validateExpiry(val) {
        if (!/^\d{2}\/\d{2}$/.test(val)) return false;
        const parts = val.split('/');
        const month = parseInt(parts[0], 10);
        const year = parseInt("20" + parts[1], 10);
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        if (month < 1 || month > 12) return false; 
        if (year < currentYear) return false; 
        if (year === currentYear && month < currentMonth) return false; 
        return true;
    }
</script>
{% endblock %}